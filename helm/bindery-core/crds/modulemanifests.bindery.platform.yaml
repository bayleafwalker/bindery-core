apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: modulemanifests.bindery.platform
spec:
  group: bindery.platform
  scope: Namespaced
  names:
    plural: modulemanifests
    singular: modulemanifest
    kind: ModuleManifest
    shortNames:
      - mm
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          description: Declarative module contract describing provided and required capabilities.
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - module
                - provides
                - requires
                - scaling
              properties:
                module:
                  type: object
                  required:
                    - id
                    - version
                  properties:
                    id:
                      type: string
                      minLength: 1
                      description: Globally unique module identifier (e.g., core.physics).
                    version:
                      type: string
                      pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
                      description: Module artifact semantic version.
                    description:
                      type: string
                    owners:
                      type: array
                      items:
                        type: string
                    repo:
                      type: string
                    license:
                      type: string
                provides:
                  type: array
                  description: Capabilities provided by this module.
                  items:
                    type: object
                    required:
                      - capabilityId
                      - version
                      - scope
                      - multiplicity
                    properties:
                      capabilityId:
                        type: string
                        pattern: "^[a-z][a-z0-9-]*(\\.[a-z][a-z0-9-]*)+$"
                      version:
                        type: string
                        pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
                      scope:
                        type: string
                        enum: [cluster, region, realm, world, world-shard, session]
                      multiplicity:
                        type: string
                        enum: ["1", many]
                      features:
                        type: object
                        properties:
                          supported:
                            type: array
                            items:
                              type: string
                      nfr:
                        type: object
                        properties:
                          latency:
                            type: object
                            properties:
                              p95Ms:
                                type: object
                                required: [value, constraint]
                                properties:
                                  value:
                                    type: number
                                    minimum: 0
                                  constraint:
                                    type: string
                                    enum: [hard, soft]
                          tickRateHz:
                            type: object
                            required: [value, constraint]
                            properties:
                              value:
                                type: number
                                minimum: 0
                              constraint:
                                type: string
                                enum: [hard, soft]
                          determinism:
                            type: object
                            required: [value, constraint]
                            properties:
                              value:
                                type: string
                                enum: [required, best-effort, none]
                              constraint:
                                type: string
                                enum: [hard, soft]
                      interfaces:
                        type: object
                        properties:
                          grpc:
                            type: array
                            items:
                              type: object
                              required: [package, service, protoRef]
                              properties:
                                package:
                                  type: string
                                service:
                                  type: string
                                protoRef:
                                  type: string
                                methods:
                                  type: array
                                  items:
                                    type: object
                                    required: [name, request, response]
                                    properties:
                                      name:
                                        type: string
                                      request:
                                        type: string
                                      response:
                                        type: string
                          events:
                            type: array
                            items:
                              type: object
                              required: [name, direction, schema]
                              properties:
                                name:
                                  type: string
                                direction:
                                  type: string
                                  enum: [publish, subscribe, both]
                                schema:
                                  type: object
                                  required: [id, version, format, schemaRef]
                                  properties:
                                    id:
                                      type: string
                                    version:
                                      type: string
                                      pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
                                    format:
                                      type: string
                                      enum: [protobuf, json, avro]
                                    schemaRef:
                                      type: string
                                orderingKey:
                                  type: string
                requires:
                  type: array
                  description: Capabilities required by this module.
                  items:
                    type: object
                    required:
                      - capabilityId
                      - versionConstraint
                      - scope
                      - multiplicity
                      - dependencyMode
                    properties:
                      capabilityId:
                        type: string
                        pattern: "^[a-z][a-z0-9-]*(\\.[a-z][a-z0-9-]*)+$"
                      versionConstraint:
                        type: string
                        minLength: 1
                        description: SemVer range expression (e.g., ^1.2.0).
                      scope:
                        type: string
                        enum: [cluster, region, realm, world, world-shard, session]
                      multiplicity:
                        type: string
                        enum: ["1", many]
                      dependencyMode:
                        type: string
                        enum: [required, optional]
                      features:
                        type: object
                        properties:
                          required:
                            type: array
                            items:
                              type: string
                          preferred:
                            type: array
                            items:
                              type: string
                      nfr:
                        type: object
                        properties:
                          latency:
                            type: object
                            properties:
                              p95Ms:
                                type: object
                                required: [value, constraint]
                                properties:
                                  value:
                                    type: number
                                    minimum: 0
                                  constraint:
                                    type: string
                                    enum: [hard, soft]
                          tickRateHz:
                            type: object
                            required: [value, constraint]
                            properties:
                              value:
                                type: number
                                minimum: 0
                              constraint:
                                type: string
                                enum: [hard, soft]
                scaling:
                  type: object
                  required: [defaultScope, statefulness]
                  properties:
                    defaultScope:
                      type: string
                      enum: [cluster, region, realm, world, world-shard, session]
                    statefulness:
                      type: string
                      enum: [stateless, stateful]
                    sharding:
                      type: object
                      properties:
                        strategy:
                          type: string
                          enum: [none, world, world-shard, session, custom]
                        key:
                          type: string
                    autoscaling:
                      type: object
                      properties:
                        minReplicas:
                          type: integer
                          minimum: 0
                        maxReplicas:
                          type: integer
                          minimum: 0
                        metricHints:
                          type: array
                          items:
                            type: object
                            required: [type, target]
                            properties:
                              type:
                                type: string
                                enum: [cpu, memory, rps, tick-lag, custom]
                              target:
                                type: string
                scheduling:
                  type: object
                  description: Kubernetes scheduling constraints (affinity, tolerations, nodeSelector).
                  x-kubernetes-preserve-unknown-fields: true
            status:
              type: object
              properties:
                observedGeneration:
                  type: integer
                  minimum: 0
                phase:
                  type: string
                  enum: [Pending, Resolved, Error]
                message:
                  type: string
                unresolvedRequires:
                  type: array
                  items:
                    type: object
                    required: [capabilityId, reason]
                    properties:
                      capabilityId:
                        type: string
                      reason:
                        type: string
                conditions:
                  type: array
                  items:
                    type: object
                    required: [type, status]
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum: ["True", "False", "Unknown"]
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
          x-kubernetes-validations:
            - rule: "has(self.spec.provides)"
              message: "spec.provides must be present"
            - rule: "has(self.spec.requires)"
              message: "spec.requires must be present"
