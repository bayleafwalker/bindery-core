apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: capabilitydefinitions.game.platform
spec:
  group: game.platform
  scope: Cluster
  names:
    plural: capabilitydefinitions
    singular: capabilitydefinition
    kind: CapabilityDefinition
    shortNames:
      - capdef
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          description: Defines a capability contract family and available versions for discovery and policy.
          required: [spec]
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - capabilityId
                - latestVersion
                - scopes
                - multiplicity
              properties:
                capabilityId:
                  type: string
                  pattern: "^[a-z][a-z0-9-]*(\\.[a-z][a-z0-9-]*)+$"
                  description: Namespaced capability ID (e.g., physics.engine).
                latestVersion:
                  type: string
                  pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
                versions:
                  type: array
                  description: Optional list of known published versions.
                  items:
                    type: string
                    pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
                scopes:
                  type: array
                  minItems: 1
                  items:
                    type: string
                    enum: [cluster, region, world, world-shard, session]
                multiplicity:
                  type: string
                  enum: ["1", many]
                features:
                  type: object
                  properties:
                    defined:
                      type: array
                      items:
                        type: object
                        required: [name, stability]
                        properties:
                          name:
                            type: string
                            minLength: 1
                          stability:
                            type: string
                            enum: [experimental, stable, deprecated]
                          description:
                            type: string
                contractRef:
                  type: object
                  description: Optional pointer to a CapabilityContract resource/doc registry.
                  properties:
                    kind:
                      type: string
                      enum: [CapabilityContract]
                    name:
                      type: string
                nfrDefaults:
                  type: object
                  properties:
                    tickRateHz:
                      type: number
                      minimum: 0
                    latencyP95Ms:
                      type: number
                      minimum: 0
                    determinism:
                      type: string
                      enum: [required, best-effort, none]
            status:
              type: object
              properties:
                observedGeneration:
                  type: integer
                  minimum: 0
                phase:
                  type: string
                  enum: [Active, Deprecated, Retired]
                message:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    required: [type, status]
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum: ["True", "False", "Unknown"]
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
